---
创建时间: 2025-04-15 22:37:45
作者: wangxiaoming
tags:
  - 长连接
  - WebSocket
---
#### 一、`WebSocket`概述
- ​**定义**​：  
    `WebSocket` 是一种基于 ​`TCP`的 ​全双工通信协议**，允许客户端与服务器建立持久连接，实现双向实时数据传输。2011 年由 IETF 定为标准（RFC 6455），支持跨域通信
- ​**核心优势**​：
    - ​**全双工**​：服务器可主动推送数据，无需客户端轮询。
    - ​**低延迟**​：单次握手后复用连接，减少网络开销。
    - ​**轻量级**​：头部信息仅 2-10 字节（无请求方法、状态码等）。
    - ​**实时性**​：适用于聊天、游戏、金融数据推送等场景

#### 二、工作原理
##### 1）握手过程
1. **HTTP 升级请求**​：  
    客户端发送带有 `Upgrade: websocket` 和 `Sec-WebSocket-Key` 的 HTTP 请求。
2. ​**服务器响应**​：  
    返回 `101 Switching Protocols` 状态码及 `Sec-WebSocket-Accept` 验证密钥，完成协议升级
```http
// 客户端请求头示例
GET /chat HTTP/1.1
Host: example.com
Upgrade: websocket
Connection: Upgrade
Sec-WebSocket-Key: dGhlIHNhbXBsZSBub25jZQ==
```
##### 2）数据传输
- **帧结构**​：  
    数据以帧（Frame）传输，包含 `Opcode`（操作类型）、`Payload Length`（负载长度）、`Mask`（掩码）等字段。
    - ​**文本帧**​（Opcode=1）：UTF-8 编码字符串。
    - ​**二进制帧**​（Opcode=2）：原始二进制数据。
    - ​**控制帧**​（如 Ping/Pong）：用于心跳检测和连接管理
- ​**心跳机制**​：  
    客户端和服务端通过 `Ping` 和 `Pong` 帧维持连接活性，防止因网络中断导致连接失效

#### 三、核心特点
|​**特性**​|​**说明**​|
|---|---|
|​**全双工通信**​|客户端和服务器可同时发送和接收数据，无需等待对方响应。|
|​**持久连接**​|单次握手后保持连接，避免频繁建立/关闭 TCP 连接的开销。|
|​**跨域支持**​|天然支持跨域，无需 CORS 配置。|
|​**二进制与文本支持**​|支持传输任意类型数据（文本、图片、文件等）。|
|​**低资源消耗**​|减少 HTTP 头部冗余，适合高并发实时场景。|
#### 四、与HTTP的对比
|​**维度**​|​**WebSocket**​|​**HTTP**​|
|---|---|---|
|​**连接方式**​|单次握手后持久连接|每次请求需新建连接|
|​**数据传输**​|双向实时|单向请求-响应|
|​**头部开销**​|2-10 字节（无状态）|每次请求携带完整头部（如 Cookie、User-Agent）|
|​**适用场景**​|实时聊天、在线游戏、金融推送|网页浏览、API 调用|
#### 五、应用场景
1. ​**实时聊天**​：  
    如即时通讯软件（`WhatsApp`、微信网页版），消息即时推送
2. ​**在线游戏**​：  
    多人游戏中的玩家操作同步（如《英雄联盟》技能释放同步）
3. ​**金融数据推送**​：  
    股票行情、汇率波动实时更新
4. ​**物联网（`IoT`）​**​：  
    设备传感器数据实时上传与控制指令下发
5. ​**协同办公**​：  
    多人协作编辑网页（如 Google Docs）的实时同步

#### 六、实现示例
todo  Android通过OKHttp实现
#### 七、优化与安全
##### 1）性能优化
- **消息压缩**​：使用 `permessage-deflate` 扩展减少传输数据量。
- ​**消息分片**​：大文件分片传输，避免单帧过大导致延迟。
- ​**负载均衡**​：通过多 `WebSocket` 服务器分担并发压力

##### 2）安全增强
- ​**加密传输**​：使用 `wss://`（`WebSocket Secure`）协议，基于 `TLS/SSL` 加密。
- ​**身份验证**​：在握手阶段通过 HTTP 头传递 Token 或`JWT`。
- ​**防 `DDoS`**​：限制连接频率，识别异常流量

#### 八、兼容性与问题
- ​**浏览器支持**​：主流浏览器（`Chrome、Firefox、Safari`）均支持，IE 10+ 部分支持。
- ​**代理兼容**​：需配置代理服务器支持 `WebSocket` 协议（如 `Nginx` 的 `proxy_set_header Upgrade`）。
- ​**连接中断**​：网络波动时需实现自动重连机制

#### 九、未来展望
- ​**协议扩展**​：可能引入更多消息类型（如流式传输、优先级队列）。
- ​**与 HTTP/3 结合**​：利用 `QUIC` 协议提升传输效率。
- ​**标准化增强**​：完善错误码定义和扩展机制
