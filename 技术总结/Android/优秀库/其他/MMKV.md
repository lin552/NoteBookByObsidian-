---
创建时间: 2025-04-12 17:24:57
作者: wangxiaoming
tags:
  - MMKV
  - SharePreference
---

#### 一、`MMKV`是什么？
`MMKV` 是腾讯开源的一款基于 `​mmap` 内存映射**的高性能 key-value 存储组件，底层序列化/反序列化采用 ​`protobuf` 协议**实现。自 2015 年起在微信中广泛应用，支持 `Android、iOS、macOS、Windows` 及鸿蒙 `HarmonyOS NEXT` 等多平台
- **高性能**：读写速度比 `SharedPreferences(SP)` 快数十至数百倍
- ​**低存储开销**：数据以二进制存储，体积比 SP 的 XML 格式减少 50% 以上
- ​**跨进程共享**：通过 `mmap` 和文件锁机制实现安全的多进程数据同步
- ​**数据加密**：支持 `AES-CFB-128` 加密，保护敏感信息

#### 二、`MMKV`与`SharePreferences`的核心差异
| **维度**      | ​**MMKV**               | ​**SharedPreferences (SP)** |
| ----------- | ----------------------- | --------------------------- |
| ​**存储机制**   | 基于 mmap 内存映射，直接操作内存     | 传统 I/O 读写，涉及用户态与内核态数据拷贝     |
| ​**数据更新方式** | 增量追加，仅修改部分数据            | 全量更新，每次修改需重写整个 XML 文件       |
| ​**多进程支持**  | 原生支持，通过文件锁和共享内存实现       | 需手动封装 ContentProvider，性能低下  |
| ​**线程安全性**  | 内置锁机制，支持多线程并发读写         | 主线程读写可能引发 ANR，需手动同步         |
| ​**数据加密**   | 支持 AES 加密，秘钥存于 Native 层 | 无原生加密，需自行实现                 |
| ​**性能对比**   | 写入 1000 次耗时约 7ms        | 写入 1000 次耗时约 1200ms         |

#### 三、存储操作：同步还是异步？
1. **`MMKV` 的写入机制**：
    - ​**同步内存操作**：数据直接写入内存映射区域，立即可见
    - ​**异步磁盘回写**：由操作系统自动将内存数据刷入磁盘，无需调用 `commit()` 或 `apply()`
    - ​**无 `ANR` 风险**：避免了 SP 因 `apply()` 异步提交时 `QueuedWork` 强制等待导致的 `ANR`
2. ​**`SharedPreferences` 的缺陷**：
    - ​**同步提交（commit）​**：阻塞主线程直至磁盘写入完成，易引发 `ANR`
    - ​**异步提交（apply）​**：虽异步但生命周期切换时仍可能触发等待，导致卡顿

#### 四、`MMKV`的核心原理
##### 1）内存映射（`mmap`）
将文件直接映射到进程虚拟内存，读写操作直接作用于内存，由系统自动回写磁盘。​**优势**包括：
- ​**零拷贝**：省去传统 I/O 的 4 次数据拷贝（用户态 ↔ 内核态 ↔ 磁盘）
- ​**Crash 安全**：即使进程崩溃，系统仍能保证数据完整性
##### 2)数据组织与增量更新
- 使用 `​protobuf` 序列化，数据以键值对形式追加到文件末尾，避免全量重写
- 文件空间满时触发 ​**重整**：合并有效数据并重置文件大小，平衡性能与空间
##### 3）跨进程与加密
- **多进程锁**：通过 `flock` 文件锁实现原子操作，确保数据一致性
- ​**匿名内存（`Ashmem`）​**：敏感数据通过匿名共享内存传递，不落盘更安全

#### 五、性能对比与实测数据
- **写入速度**：`MMKV` 写入 1000 次耗时约 `7ms`，SP 为 `1200ms`，提升近 ​**170 倍**
- ​**内存占用**：`MMKV` 仅映射必要内存页，SP 需全量加载 XML 到内存，内存节省 50% 以上
- ​**多线程场景**：`MMKV` 支持 1000 个并发线程同时读写，SP 需手动加锁且性能骤降