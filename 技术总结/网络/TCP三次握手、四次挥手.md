---
创建时间: 2025-04-18 09:35:13
作者: wangxiaoming
tags:
  - TCP
---
#### 一、`TCP`三次握手
##### 1）过程描述
三次握手用于建立可靠的双向通信通道：
1. ​`SYN`​：客户端发送`SYN=1`（同步请求）和随机初始序列号`seq=x`，进入`SYN_SENT`状态
2. `SYN-ACK`：服务器返回`SYN=1`、`ACK=1`（确认）及随机初始序列号`seq=y`，确认号`ack=x+1`，进入`SYN_RCVD`状态
3. ​`ACK`：客户端发送`ACK=1`和确认号`ack=y+1`，双方进入`ESTABLISHED`状态，连接建立完成
##### 2）高频问题与回答技巧
​**为什么是三次握手？**
- 两次握手无法确认客户端的接收能力（服务器可能误认为连接已建立），四次冗余。三次握手确保双方收发能力正常，防止历史连接干扰
​**第三次握手能否携带数据？​**
- 可以（如HTTP长连接），但前两次不行，避免SYN洪水攻击（攻击者伪造大量SYN占用服务器资源）
​**半连接队列（SYN队列）的作用？**
- 存储未完成握手的连接请求，队列满时可能导致正常请求被丢弃（需防范SYN攻击）

#### 二、`TCP`四次挥手
##### 1）过程描述
四次挥手用于安全终止全双工连接：
1. ​`FIN`​：主动关闭方（如客户端）发送`FIN=1`，进入`FIN_WAIT_1`状态
2. ​`ACK`​：被动关闭方（如服务器）返回`ACK=1`，进入`CLOSE_WAIT`状态（可能继续发送剩余数据）
3. `​FIN​`：被动关闭方完成数据发送后发送`FIN=1`，进入`LAST_ACK`状态
4. `ACK`：主动关闭方发送最终`ACK=1`，进入`TIME_WAIT`状态（等待`2MSL`），确保被动关闭方收到确认
##### 2）高频问题与回答技巧
​**为什么需要四次挥手？**
全双工通信需独立关闭两个方向。被动关闭方收到`FIN`后需处理剩余数据，不能立即关闭
​**TIME_WAIT状态的作用？**
等待`2MSL`（报文最大生存时间）确保最后一个`ACK`到达，防止旧报文干扰新连接（如端口复用导致数据混乱）
​**CLOSE_WAIT状态过多怎么办？​**
通常是代码未正确关闭连接（如未调用`close()`），需检查资源释放逻辑
#### 三、面试考察延伸问题
##### 1）协议设计思想
- ​**动态`ISN`（初始序列号）​**​：防止攻击者猜测序列号伪造`RST`报文终止连接
- ​**保活机制（Keep-Alive）​**​：长时间无数据时发送探测包，避免连接僵死（默认2小时无响应关闭）
##### 2）异常场景分析
- ​**大量TIME_WAIT**​：常见于高并发短连接服务（如爬虫），可通过调整内核参数（如`net.ipv4.tcp_tw_reuse`）优化
- ​**SYN攻击防御**​：启用`SYN Cookie`或限制半连接队列长度

