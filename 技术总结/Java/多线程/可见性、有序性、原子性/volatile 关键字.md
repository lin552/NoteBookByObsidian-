---
创建时间: 2025-04-12 17:24:57
作者: wangxiaoming
tags:
  - Java
  - volatile
---
#### 一、核心作用
`volatile` 是 Java 提供的 ​**轻量级同步机制**，用于解决多线程环境下的 ​**可见性** 和 ​**有序性** 问题，但不保证原子性
。其核心功能包括：
- ​**可见性**：强制线程直接从主内存读取变量最新值，修改后立即刷新到主内存，确保其他线程能感知变化
- ​**有序性**：禁止指令重排序（通过内存屏障），保证程序执行顺序与代码顺序一致

> ​**示例**：若变量未声明为 `volatile`，线程可能因本地缓存旧值导致死循环（如状态标志位未更新）

#### 二、`JMM` 与 `volatile` 的关系
**`JMM` 核心机制**：
- 所有变量存储在主内存，线程操作需通过本地内存（工作内存）副本进行
- 普通变量修改后何时同步到主内存不确定，而 `volatile` 变量修改会 ​**立即刷新到主内存**，且其他线程读取时 ​**强制失效本地缓存**，重新从主内存加载

**内存交互操作**：  
`volatile` 变量的读写会触发以下操作：
```text
read → load → use → assign → store → write
```

#### 三、volatile 的底层实现原理
- ​**硬件级支持**：
    - 对 `volatile` 变量的写操作会生成带有 ​**`lock` 前缀** 的汇编指令（如 `lock addl $0x0, (%rsp)`），触发两件事
        1. ​**强制写回主内存**：将当前处理器缓存行的数据写回系统内存。
        2. ​**缓存一致性协议（如 `MESI`）​**：其他 CPU 缓存中该变量的副本会被标记为无效，需重新从主内存加载。
    - 通过 ​**内存屏障** 禁止编译器和处理器重排序指令


#### 四、典型使用场景
##### 1）状态标志位（如线程退出标志 while(!exit)）
```java
volatile boolean exit = false;
// 线程 A
exit = true;
// 线程 B
while (!exit) { ... }
```
##### 2)一次性发布（单例模式的`DCL`双重检查锁）
```java
private volatile static Singleton instance;
public static Singleton getInstance() {
    if (instance == null) {
        synchronized (Singleton.class) {
            if (instance == null) {
                instance = new Singleton();
            }
        }
    }
    return instance;
}
```
##### 3）独立观察：多个线程独立更新共享变量（如计时器）
#### 五、volatile的局限性
- ​**不保证原子性**：  
    `volatile` 无法解决复合操作（如 `i++`）的线程安全问题    
    > ​**示例**：两个线程同时对 `volatile int counter` 自增 1000 次，结果可能小于 2000
    > ​**解决方案**：使用 `AtomicInteger` 或 `synchronized`。
    
- ​**不替代锁**：无法处理需要互斥访问的复杂临界区

#### 六、volatile 与 synchronized 对比
| ​**维度**   | `volatile`     | `synchronized` |
| --------- | -------------- | -------------- |
| ​**可见性**  | 直接保证           | 通过锁释放前刷新主内存保证  |
| ​**原子性**  | 不保证            | 保证             |
| ​**有序性**  | 部分保证（禁止重排序）    | 完全保证（锁内串行执行）   |
| ​**性能开销** | 低（无上下文切换）      | 高（线程阻塞、锁竞争）    |
| ​**适用场景** | 单一变量状态标志、轻量级同步 | 复杂临界区、需原子性操作   |
#### 七、注意事项
1. ​**避免滥用**：仅在必要时使用，过度使用可能导致性能下降（频繁主内存访问）。
2. ​**结合原子类**：如 `AtomicInteger`，实现无锁线程安全
3. ​**理解 JMM 约束**：需明确 `happens-before` 规则对多线程交互的影响