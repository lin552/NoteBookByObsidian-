---
创建时间: 2025-03-14T18:39:00
作者: wangxiaoming
tags:
  - JVM
---

#### 一、JVM核心组成
##### 0）模型图示
![[Pasted image 20250323175933.png]]
##### 1）类加载器 （Class Loader）

​**功能**：加载 `.class` 文件到内存，并转换为 JVM 可识别的数据结构。
- ​**分类**：
    - ​**启动类加载器**：加载核心类库（如 `rt.jar`）。
    - ​**扩展类加载器**：加载 `ext` 目录下的扩展类。
    - ​**应用程序类加载器**：加载用户类路径（ClassPath）的类。
    - ​**自定义类加载器**：用户可继承 `ClassLoader` 实现自定义加载逻辑。
- ​**双亲委派模型**：优先由父类加载器加载类，避免重复加载并确保安全。

##### 2）运行时数据区 （Runtime Data Areas）

JVM 内存管理的核心区域，分为 ​**线程私有** 和 ​**线程共享** 区域：

- **线程私有区域**：
    - ​**程序计数器**：记录当前线程执行的字节码指令地址，==唯一不会发生内存溢出的区域。==
    - ​**虚拟机栈**：存储方法调用的栈帧（局部变量表、操作数栈、动态链接等），可能抛出 `StackOverflowError` 或 `OutOfMemoryError`。
    - ​**本地方法栈**：为 Native 方法（如 C/C++ 实现）服务，结构与虚拟机栈类似。

- ​**线程共享区域**：
    - ​[[JVM 内存模型#1）堆内存（Heap）]]：存储所有对象实例和数组，分为 ​**新生代**​（Eden、Survivor 区）和 ​**老年代**，是垃圾回收（GC）的主战场
    - ​[[JVM 内存模型#2）方法区与元空间]]**：存储类元数据（类名、字段、方法）、运行时常量池、静态变量等

##### 3）执行引擎（Execution Engine）

- **解释器**：逐行解释字节码，启动速度快但效率低。
- ​**即时编译器（JIT）​**：将热点代码编译为本地机器码，提升执行效率（如 HotSpot 的分层编译）。
- ​**垃圾回收器（GC）​**：自动回收堆中不再使用的对象，常见算法包括 ​**标记-清除**、**复制算法**​（新生代）、**标记-整理**​（老年代）
##### 4)本地方法接口（JNI）
支持调用 C/C++ 等语言编写的本地库，扩展 Java 的底层能力（如操作系统 API 调用）

#### 二、JVM内存模型详解

##### 1）堆内存（Heap）
- **结构**：
    - ​**新生代**：分为 Eden 区（新对象分配区）和两个 Survivor 区（From/To），采用复制算法回收短生命周期对象。
    - ​**老年代**：存放长期存活对象，使用标记-整理算法减少内存碎片
- ​**调优参数**：
    - `-Xms` 和 `-Xmx` 分别设置堆的初始大小和最大值。
    - 默认当堆空余小于 40% 时扩容，大于 70% 时缩容
##### 2）方法区与元空间
- **演变**：JDK 8 前为 ​**永久代**​（固定大小易溢出），JDK 8+ 改为 ​**元空间**​（使用本地内存动态扩展）
- ​**内容**：类信息、常量池、静态变量、JIT 编译后的代码缓存。

##### 3) 栈与程序计数器
- **虚拟机栈**：每个方法调用生成一个栈帧，存储局部变量和中间结果。栈深度过大导致 `StackOverflowError`，扩展失败则抛出 `OutOfMemoryError`
- ​**程序计数器**：线程切换时恢复执行位置，无内存溢出风险

##### 4）直接内存（Direct Memory）
通过 `ByteBuffer.allocateDirect()` 分配，绕过堆直接使用物理内存，提升 I/O 性能（如 NIO 文件操作）

#### 三、垃圾回收(GC)机制
- ​**分代回收理论**：基于“弱代假说”（大部分对象生命周期短），新生代频繁回收，老年代较少回收
- ​**GC 触发条件**：
    - ​**Minor GC**：当 Eden 区满时触发，存活对象复制到 Survivor 区。
    - ​**Full GC**：老年代空间不足或方法区溢出时触发，停顿时间较长
- ​**优化策略**：
    - 避免大对象直接进入老年代（通过 `-XX:PretenureSizeThreshold` 设置阈值）。
    - 动态年龄判断：Survivor 区中同龄对象总大小超半时直接晋升老年
- ​**回收算法：[[垃圾回收算法]]
